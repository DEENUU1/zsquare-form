<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with AI</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/RecordRTC/5.6.2/RecordRTC.min.js"></script>
</head>
<body>
    <div id="chat-container">
        <div id="chat-messages"></div>
        <form id="chat-form">
            <input type="text" id="message-input" placeholder="Type your message...">
            <button type="submit">Send</button>
        </form>
        <button id="start-recording">Start Recording</button>
        <button id="stop-recording" disabled>Stop Recording</button>
    </div>

<script>
    const sessionId = Date.now().toString();
    let recorder;

    function addMessage(message, isBot) {
        const messageDiv = document.createElement('div');
        messageDiv.className = isBot ? 'bot-message' : 'user-message';
        messageDiv.textContent = message;
        document.getElementById('chat-messages').appendChild(messageDiv);
    }

    $('#chat-form').submit(function(e) {
        e.preventDefault();
        const message = $('#message-input').val();
        if (message) {
            $.post('/dashboard/chat', { message: message, session_id: sessionId }, function(data) {
                if (data.user_message) {
                    addMessage(data.user_message.message, false);
                }
                if (data.bot_response) {
                    addMessage(data.bot_response.message, true);
                    if (data.bot_response.audioUrl) {
                        const audio = new Audio(data.bot_response.audioUrl);
                        audio.play();
                    }
                }
            });
            $('#message-input').val('');
        }
    });

    $('#start-recording').click(function() {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(function(stream) {
                recorder = RecordRTC(stream, { type: 'audio' });
                recorder.startRecording();
                $('#start-recording').prop('disabled', true);
                $('#stop-recording').prop('disabled', false);
            });
    });

    $('#stop-recording').click(function() {
        recorder.stopRecording(function() {
            let blob = recorder.getBlob();
            let formData = new FormData();
            formData.append('audio', blob, 'recording.wav');
            formData.append('session_id', sessionId);

            $.ajax({
                url: '/dashboard/audio',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(data) {
                    if (data.user_message) {
                        addMessage(data.user_message.message, false);
                    }
                    if (data.bot_response) {
                        addMessage(data.bot_response.message, true);
                        if (data.bot_response.audioUrl) {
                            const audio = new Audio(data.bot_response.audioUrl);
                            audio.play();
                        }
                    }
                }
            });

            $('#start-recording').prop('disabled', false);
            $('#stop-recording').prop('disabled', true);
        });
    });
</script>
</body>
</html>